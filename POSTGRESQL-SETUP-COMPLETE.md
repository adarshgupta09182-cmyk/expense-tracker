# PostgreSQL Migration - Complete Step-by-Step Guide

## Overview
You're migrating from JSON file storage to PostgreSQL for permanent data persistence. This guide shows you exactly where to find the connection string and how to complete the migration.

---

## STEP 1: Add PostgreSQL to Railway (5 minutes)

### 1.1 Go to Railway Dashboard
1. Open https://railway.app in your browser
2. Log in with your account
3. Click on your **expense-tracker** project

### 1.2 Add PostgreSQL Database
1. Click the **+ New** button (top right)
2. Select **Database** from the menu
3. Click **PostgreSQL**
4. Railway will create a PostgreSQL instance automatically
5. Wait 30-60 seconds for it to initialize

### 1.3 You'll see a new service called "PostgreSQL" in your project

---

## STEP 2: Find Your Connection String (2 minutes)

### 2.1 Locate the Connection String
1. In Railway, click on the **PostgreSQL** service (the new database you just created)
2. Click the **Connect** tab
3. You'll see a section called **Database URL**
4. **Copy the entire connection string** - it looks like:
   ```
   postgresql://postgres:abc123xyz@containers-us-west-45.railway.app:6543/railway
   ```

### 2.2 Connection String Format Explained
```
postgresql://username:password@hostname:port/database_name
```
- **username**: Usually `postgres`
- **password**: Random string generated by Railway
- **hostname**: Railway's server address
- **port**: Usually `6543` or `5432`
- **database_name**: Usually `railway`

### 2.3 Save This Connection String
- Copy it to a text file or notepad
- You'll need it in the next step

---

## STEP 3: Add DATABASE_URL to Railway Web Service (3 minutes)

### 3.1 Go to Your Web Service
1. In Railway, click on the **web** service (your Node.js app)
2. Click the **Variables** tab

### 3.2 Add DATABASE_URL Variable
1. Click **Add Variable** button
2. In the **Name** field, type: `DATABASE_URL`
3. In the **Value** field, paste the connection string you copied in Step 2
4. Click **Save** or **Deploy**

### 3.3 Example
```
Name: DATABASE_URL
Value: postgresql://postgres:abc123xyz@containers-us-west-45.railway.app:6543/railway
```

### 3.4 Wait for Redeploy
- Railway will automatically redeploy your web service
- Watch the logs to see it restart
- This takes about 1-2 minutes

---

## STEP 4: Switch to PostgreSQL Server (2 minutes)

### 4.1 Backup Current Server
1. Open your project in your code editor
2. Rename `server.js` to `server-json.js` (this is your backup)

### 4.2 Switch to PostgreSQL
1. Rename `server-postgres.js` to `server.js`

### 4.3 Commit and Push to GitHub
```bash
git add .
git commit -m "Migrate to PostgreSQL database"
git push
```

### 4.4 Railway Auto-Redeploys
- Railway will automatically detect the changes
- Your app will redeploy with PostgreSQL
- Watch the logs to confirm it starts successfully

---

## STEP 5: Verify Migration (5 minutes)

### 5.1 Test Login
1. Go to https://expense-tracker-rho-brown.vercel.app
2. Try to login with: `test@example.com` / `test123456`
3. You should see the dashboard

### 5.2 Add a Test Expense
1. Click "Add Expense"
2. Fill in the form with any values
3. Click "Add"
4. The expense should appear in the table

### 5.3 Refresh the Page
1. Press F5 or Ctrl+R to refresh
2. The expense should still be there
3. ✅ This confirms PostgreSQL is working!

### 5.4 Redeploy and Test Again
1. Go to Railway and manually redeploy the web service
2. Wait for it to restart
3. Go back to the app and refresh
4. The expense should STILL be there
5. ✅ This confirms data persists across redeploys!

---

## STEP 6: Troubleshooting

### Issue: "Connection refused" or "ECONNREFUSED"
**Solution:**
1. Check that DATABASE_URL is set on Railway
2. Verify the connection string is correct (no typos)
3. Make sure PostgreSQL service is running (check Railway dashboard)

### Issue: "Error: connect ENOTFOUND"
**Solution:**
1. Check the hostname in your connection string
2. Make sure you copied the entire connection string from Railway
3. Verify there are no spaces at the beginning or end

### Issue: "Error: password authentication failed"
**Solution:**
1. The password in the connection string might have special characters
2. Copy the connection string again from Railway (don't edit it manually)
3. Make sure you're using the exact string from Railway

### Issue: "relation 'users' does not exist"
**Solution:**
1. This means the database tables weren't created
2. Check the server logs on Railway
3. The tables should be created automatically on first run
4. If not, the migration script may have failed
5. Check that `users.json` and `expenses.json` exist in your project

### Issue: Data Not Persisting After Redeploy
**Solution:**
1. Verify DATABASE_URL is set correctly on Railway
2. Check that PostgreSQL service is running
3. Look at Railway logs for any SQL errors
4. Make sure you're using `server.js` (not `server-json.js`)

---

## STEP 7: Local Testing (Optional)

### 7.1 Install PostgreSQL Locally
If you want to test locally before deploying:

**Windows:**
1. Download PostgreSQL from https://www.postgresql.org/download/windows/
2. Install with default settings
3. Remember the password you set for `postgres` user

**Mac:**
```bash
brew install postgresql
brew services start postgresql
```

**Linux:**
```bash
sudo apt-get install postgresql postgresql-contrib
sudo service postgresql start
```

### 7.2 Create Local Database
```bash
createdb expense_tracker
```

### 7.3 Update .env for Local Testing
```
DATABASE_URL=postgresql://postgres:your_password@localhost:5432/expense_tracker
```

### 7.4 Test Locally
```bash
npm install
node server.js
```

---

## STEP 8: Rollback Plan (If Needed)

If something goes wrong and you need to go back to JSON storage:

### 8.1 Switch Back to JSON
1. Rename `server.js` to `server-postgres.js`
2. Rename `server-json.js` to `server.js`

### 8.2 Commit and Push
```bash
git add .
git commit -m "Rollback to JSON storage"
git push
```

### 8.3 Railway Auto-Redeploys
- Your app will redeploy with JSON storage
- All your old data from `users.json` and `expenses.json` will be available

---

## Summary of Changes

| Aspect | Before | After |
|--------|--------|-------|
| Storage | JSON files | PostgreSQL database |
| Data Persistence | Lost on redeploy | Persists forever |
| Performance | Slower (file I/O) | Faster (indexed queries) |
| Scalability | Limited | Unlimited |
| Backup | Manual | Automatic (Railway) |

---

## Next Steps

1. ✅ Add PostgreSQL to Railway (Step 1)
2. ✅ Copy connection string (Step 2)
3. ✅ Add DATABASE_URL to Railway (Step 3)
4. ✅ Switch to PostgreSQL server (Step 4)
5. ✅ Verify migration works (Step 5)
6. ✅ Test data persistence (Step 5.4)

**You're done!** Your app now has permanent data storage with PostgreSQL.

---

## Questions?

If you get stuck:
1. Check the troubleshooting section above
2. Look at Railway logs: https://railway.app → Select project → web service → Logs tab
3. Check browser console (F12) for any errors
4. Verify all environment variables are set correctly

